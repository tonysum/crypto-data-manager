# 实现 K 线数据自动实时更新程序（支持开机自启）

针对您关心的“关机重启后能否自动启动”的问题，答案是：**可以！** `pm2` 配合简单的配置，就能实现“一次设置，终身自动运行”。

## 1. 生活中的类比：自动报时钟与“超级管家”

*   **报时钟**：即我们的 `scheduler_klines.py` 脚本。
*   **超级管家 (pm2)**：它不仅负责看着钟，还负责在停电（关机）后，一旦来电（开机），第一时间跑进房间把钟重新挂好并调准时间。

## 2. 逻辑流程图 (ASCII)

```text
[ 电脑开机 ] 
      |
      V
[ 系统服务 (Systemd/Launchd) ] --(启动)--> [ pm2 守护进程 ]
                                            |
                                            V
                                [ pm2 自动恢复之前的任务 ]
                                            |
                                            V
                                [ 运行 scheduler_klines.py ]
                                            |
                    ------------------------------------------------
                    |               |               |              |
                [ 5m 任务 ]     [ 1h 任务 ]     [ 4h 任务 ]    [ 1d 任务 ]
```

## 3. 技术方案：如何实现开机自启？

如果您选择 `pm2` 方案，只需要三个步骤即可实现永久自动化：

1.  **启动程序**：
    ```bash
    pm2 start backend/scheduler_klines.py --name "crypto-scheduler" --interpreter python3
    ```
2.  **生成开机启动脚本**：
    ```bash
    pm2 startup
    ```
    *执行后，终端会给出一行以 `sudo` 开头的指令，您直接复制并执行它即可。这会告诉操作系统在启动时先拉起 pm2。*
3.  **冻结当前状态**：
    ```bash
    pm2 save
    ```
    *这一步非常关键！它会将当前正在运行的程序列表“保存快照”。下次开机时，pm2 会根据这个快照自动恢复所有程序。*

## 4. 核心步骤：编写 `backend/scheduler_klines.py`

我将为您实现一个健壮的调度脚本：
- **智能触发**：每分钟扫描，支持 5m, 15m, 1h, 4h, 1d 等多个维度。
- **并发控制**：如果 5 分钟任务还在跑，下一轮会自动跳过，避免互相干扰。
- **自动补全**：利用现有的 `auto_update_all_symbols` 逻辑，确保数据没有断层。

## 5. 关键的“坑” (Gotcha)

**路径依赖问题**：
当程序随系统开机启动时，它的“当前工作目录”可能不是您预期的目录。
**解决方案**：
在脚本内部，我会使用 `Path(__file__)` 自动锁定项目的根目录，确保无论在哪里启动，它都能正确找到数据库配置文件和日志存放路径。

---
**您是否同意此方案？如果确认，我将立即开始编写代码。**
