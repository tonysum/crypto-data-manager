# 加密货币数据管理系统技术方案 (Technical Manifesto)

## 1. 项目概述与目标
本项目旨在构建一个自动化、健壮的加密货币 K 线数据库。它不仅负责从交易所获取实时和历史数据，还通过智能调度和自愈机制，确保数据的绝对完整性与连续性，为后续的量化策略提供坚实的数据底座。

- **核心栈**：Python (FastAPI, SQLAlchemy), PostgreSQL, Next.js, TailwindCSS.
- **关键依赖**：Binance SDK, Pandas, UV (包管理), PM2 (进程管理).

---

## 2. 核心架构设计
系统采用分层架构，确保各组件职责单一、易于维护。

### A. 接入层 ([binance_client.py](backend/binance_client.py))
- **职责**：封装币安 API 调用。
- **技术亮点**：
    - 实现了基于“指数退避”算法的自动重试装饰器。
    - 统一管理 API Key、代理设置与超时逻辑。
    - 自动处理交易对状态过滤（只处理 `TRADING` 状态）。

### B. 逻辑层 ([download_klines.py](backend/download_klines.py))
- **职责**：执行具体的数据下载、补全与存储。
- **技术亮点**：
    - **差量更新**：每次下载前先查询数据库，仅请求缺失的时间段。
    - **自动切片**：针对币安 1500 条单次请求限制，自动将大时间跨度拆分为多个子任务。
    - **冲突自愈**：遇到 `UniqueViolation`（主键冲突）时，自动降级为“逐条插入”模式，智能跳过重复数据。

### C. 调度层 ([scheduler_klines.py](backend/scheduler_klines.py))
- **职责**：全天候监控时间点，触发下载任务。
- **技术亮点**：
    - **生产-消费模型**：引入 `asyncio.Queue` 实现任务串行化。
    - **排队机制**：解决多周期（如 5m, 1h 同时到达）时的瞬间请求过载。

---

## 3. 核心思路的演进 (Milestones)

### 第一阶段：脚本化同步 (Script Era)
*   **做法**：手动运行 Python 脚本，通过简单的循环下载数据。
*   **痛点**：手动操作低效；遇到网络错误或数据重复会直接崩溃；无法处理大规模交易对。

### 第二阶段：并行调度与 Web 化 (Parallel Era)
*   **改进**：引入 FastAPI 后端和 PM2 调度；使用 `asyncio.gather` 并行启动 5m、1h 等任务。
*   **教训**：**IP 封禁危机**。由于瞬间并发请求量过大，触发了币安每分钟 2400 次的严格限制，导致 IP 被封禁 10 小时。
*   **反思**：对于 API 受限的资源，并行并不是最优解，稳健才是。

### 第三阶段：稳健串行队列 (Robust Era)
*   **改进**：
    1.  **改为串行**：引入异步队列，所有任务排队执行，确保同一秒钟只有一个下载任务在跑。
    2.  **极限制速**：将请求延迟强制设为 3.0s，每处理一批次休息 30s。
    3.  **静默休眠**：检测到 API 封禁后，系统自动进入 10 分钟“静默期”，避免持续骚扰 API。
*   **结果**：系统可以 24/7 稳定运行，无人工干预，且能自动找回程序关闭期间缺失的所有数据。

---

## 4. 关键挑战与解决方案 (Technical Challenges)

| 挑战 | 解决方案 | 核心代码参考 |
| :--- | :--- | :--- |
| **IP 封禁 (Rate Limit)** | 异步队列串行化 + 强制 3s 延迟 | [scheduler_klines.py](backend/scheduler_klines.py) |
| **数据重复 (Unique Violation)** | 异常捕获 + 逐条插入自愈模式 | [download_klines.py](backend/download_klines.py) |
| **事件循环阻塞 (Blocking I/O)** | 使用 `asyncio.to_thread` 桥接同步 SDK | [scheduler_klines.py](backend/scheduler_klines.py) |
| **内存溢出 (OOM)** | 分批处理 (Batch Processing) | [download_klines.py](backend/download_klines.py) |

---

## 5. 总结与未来展望

该方案的核心思想是：**“在限制中寻找最优平衡”**。通过牺牲一定的实时性（秒级），换取了极高的系统可靠性（月级）。

**下一步演进方向：**
1.  **WebSocket 旁路接入**：在保持 REST 调度补全的基础上，增加 WebSocket 监听，实现无感知的毫秒级增量更新。
2.  **多代理轮询**：引入代理池，突破单 IP 的频率上限。
3.  **数据校验层**：定期对比本地数据库与交易所数据的统计摘要（如成交量之和），自动修复受损记录。

---
*Generated by AI Assistant on 2026-01-28*
